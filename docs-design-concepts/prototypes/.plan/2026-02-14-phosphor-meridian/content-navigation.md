# Content & Navigation System Specification

> Part of [VCR2 Architecture Plan](./index.md)

## Overview

Documentation content is sourced from MDX files (symlinked from the main docs project), loaded at build time, and mapped onto a linear "tape" model. Navigation between pages uses VCR metaphors: fast-forward, rewind, play, pause. The Zapper shoots links to jump to specific tape positions.

---

## Content Source: Symlinked MDX

### Directory Setup

The documentation source lives at `~/src/tasks/docs/src/content/docs/`. Rather than duplicating these files, we symlink the parent directory:

```bash
# During project setup
ln -s ~/src/tasks/docs/src/content/docs vcr2/content/docs
```

This means:
- Content updates in the main docs project are immediately reflected
- No content duplication or sync issues
- The MDX files are the single source of truth

### Content Structure (from docs project)

```
content/docs/                          # symlink → ~/src/tasks/docs/src/content/docs
├── index.mdx                          # Landing page
├── getting-started/
│   ├── install.mdx
│   └── quickstart.mdx
├── operations/                        # 39 command reference pages
│   ├── index.mdx
│   ├── add.mdx
│   ├── claim.mdx
│   ├── cycle.mdx
│   ├── ...
│   └── work.mdx
├── workflows/
│   ├── daily-loop.mdx
│   ├── health-checks.mdx
│   └── multi-agent.mdx
├── agent-usage/
│   └── agent-workflows.mdx
├── schema-and-data/
│   ├── data-export.mdx
│   └── schema.mdx
├── parity/
│   ├── command-differences.mdx
│   └── typescript-parity.mdx
└── faq/
    └── common-questions.mdx
```

Total: ~48 MDX files across 7 sections.

---

## Tape Model

### Concept

The VHS tape is a linear medium. All 48 documentation pages are arranged in a linear sequence on the tape. Each page occupies a segment of tape, identified by a timecode position.

```
TAPE:
|--- Welcome ---|--- Install ---|--- Quickstart ---|--- add ---|--- add-epic ---| ... |--- FAQ ---|
00:00:00         00:02:30        00:05:00           00:07:30    00:10:00              02:00:00
```

### Tape Position Calculation

Each page gets a timecode position based on its order in the tape:

```typescript
interface TapePage {
    id: string;              // e.g., "getting-started/install"
    title: string;           // From MDX frontmatter
    section: string;         // e.g., "getting-started"
    order: number;           // Global order on tape
    tapePosition: number;    // Timecode in seconds (e.g., 150.0)
    duration: number;        // How long this page's "segment" is (seconds)
    content: string;         // Parsed MDX content (text for display)
    links: TapeLink[];       // Outgoing links to other pages
}

interface TapeLink {
    label: string;           // Display text
    targetPageId: string;    // Target page ID
    targetPosition: number;  // Target tape position (for FF/REW direction)
}

interface TapeModel {
    pages: TapePage[];
    totalDuration: number;   // Total tape length in seconds
    currentPosition: number; // Current playhead position
    currentPageId: string;   // Currently displayed page
}
```

### Page Ordering

Pages are ordered by section, then by filename within section:

1. `index.mdx` (Welcome)
2. `getting-started/install.mdx`
3. `getting-started/quickstart.mdx`
4. `agent-usage/agent-workflows.mdx`
5. `operations/index.mdx`
6. `operations/add.mdx` ... `operations/work.mdx` (alphabetical)
7. `workflows/daily-loop.mdx` ... `workflows/multi-agent.mdx`
8. `schema-and-data/data-export.mdx`, `schema-and-data/schema.mdx`
9. `parity/command-differences.mdx`, `parity/typescript-parity.mdx`
10. `faq/common-questions.mdx`

Each page is assigned a duration of 2.5 minutes (150 seconds) of tape. Total tape: ~48 pages × 150s = 7200s = 2:00:00. This gives realistic VHS timecodes.

---

## Content Loading

### Build-Time vs Runtime

**Approach: Hybrid**

- **Build time (Vite plugin):** Scan the symlinked `content/docs/` directory, extract frontmatter, generate a manifest JSON with page metadata (id, title, section, order, file path)
- **Runtime:** Load individual MDX files on demand when a page is navigated to. Parse with `marked` (Markdown subset — we don't need full MDX component support for the CRT display)

### Content Manifest

Generated at build time:

```typescript
// Auto-generated by Vite plugin
export const tapeManifest: TapeManifestEntry[] = [
    { id: 'index', title: 'Welcome', section: 'root', order: 0, file: 'index.mdx' },
    { id: 'getting-started/install', title: 'Installation', section: 'getting-started', order: 1, file: 'getting-started/install.mdx' },
    // ...
];
```

### MDX Parsing

Since we're displaying text on a CRT screen (not rendering HTML), we parse MDX to a simplified text representation:

```typescript
interface ParsedPage {
    title: string;
    sections: ParsedSection[];
    links: { label: string; target: string }[];
}

interface ParsedSection {
    heading?: string;
    lines: ParsedLine[];
}

interface ParsedLine {
    type: 'text' | 'code' | 'heading' | 'link' | 'list-item' | 'blank';
    content: string;
    indent: number;
    linkTarget?: string;  // For 'link' type
}
```

We strip:
- HTML/JSX components (not renderable on CRT)
- Images (no image display on the VCR screen)
- Complex formatting (tables become simple text)

We keep:
- Text content
- Headings (rendered larger/brighter)
- Code blocks (rendered in different color, e.g., amber)
- Links (rendered as shootable cyan targets)
- Lists (rendered with bullet characters)

---

## Navigation System

### Navigation Store (Zustand)

```typescript
interface NavigationState {
    // Current state
    currentPageId: string;
    currentTapePosition: number;
    targetPageId: string | null;     // Set during FF/REW transitions
    targetTapePosition: number | null;

    // Page data
    currentPage: ParsedPage | null;
    isLoading: boolean;

    // Navigation history
    history: string[];               // Page ID stack
    historyIndex: number;

    // Transition state
    transitionState: 'IDLE' | 'FF_START' | 'FF_SEEK' | 'FF_ARRIVE' | 'REW_START' | 'REW_SEEK' | 'REW_ARRIVE';
    transitionProgress: number;      // 0-1

    // Actions
    navigateTo: (pageId: string) => void;
    goBack: () => void;
    goForward: () => void;
    setPage: (pageId: string, page: ParsedPage) => void;
}
```

### Navigation Flow

When a user shoots a link:

```
1. User shoots link → navigateTo(targetPageId)
2. Calculate direction:
   - target.tapePosition > current.tapePosition → FAST FORWARD
   - target.tapePosition < current.tapePosition → REWIND
3. Set VCR state to FF or REW
4. Play transition animation (see below)
5. At arrival: load target page content
6. Set VCR state to PLAY briefly, then PAUSE
7. Display new page content
```

### VCR State Coordination

The navigation store coordinates with the VCR store:

```typescript
// In navigateTo action:
navigateTo: (targetId) => {
    const targetPage = tapeManifest.find(p => p.id === targetId);
    const currentPos = get().currentTapePosition;
    const targetPos = targetPage.tapePosition;

    // Determine direction
    const direction = targetPos > currentPos ? 'FF' : 'REW';

    // Update VCR store
    vcrStore.getState().setMode(direction);
    vcrStore.getState().setTargetPosition(targetPos);

    // Update navigation store
    set({
        targetPageId: targetId,
        targetTapePosition: targetPos,
        transitionState: `${direction}_START`,
        transitionProgress: 0,
    });
}
```

---

## FF/REW Transition Animation

### Timeline (1.5 seconds total)

```
Phase       Time        Duration    Visual
─────────────────────────────────────────────────
START       0.0-0.2s    200ms       Screen tears, static burst
SEEK        0.2-1.1s    900ms       Rapid frame scroll, timecode advancing, speed lines
ARRIVE      1.1-1.5s    400ms       Deceleration, tracking settles, new page "plays in"
```

### Visual Effects During Transition

**START Phase:**
- VHS shader `uFFSpeed` or `uREWSpeed` ramps from 0 → 1.0
- Static burst (noise spike)
- Current page content distorts

**SEEK Phase:**
- Screen shows rapidly scrolling "frames" (vertical motion)
- Timecode display advances rapidly
- Horizontal tear lines appear
- Speed lines (subtle horizontal streaks)
- Glimpses of page content flashing by (optional, complex)

**ARRIVE Phase:**
- Speed decreases (uniform ramps down)
- Tracking wobbles then settles
- New page content fades/resolves in
- VCR mode transitions: FF/REW → PLAY → PAUSE
- Timecode shows final position

### Implementation

The transition is driven by the VCR store and rendered through the VHS shader uniforms:

```typescript
// In useFrame callback:
const updateTransition = (delta: number) => {
    const { transitionState, transitionProgress } = navigationStore.getState();
    if (transitionState === 'IDLE') return;

    const newProgress = transitionProgress + delta / TRANSITION_DURATION;

    if (newProgress >= 1.0) {
        // Transition complete
        navigationStore.getState().completeTransition();
        return;
    }

    // Map progress to shader uniforms
    const phase = getPhase(newProgress);
    switch (phase) {
        case 'START':
            vhsUniforms.uFFSpeed.value = easeIn(localProgress) * 1.0;
            vhsUniforms.uStaticNoise.value = 0.3 * (1 - localProgress);
            break;
        case 'SEEK':
            vhsUniforms.uFFSpeed.value = 1.0;
            // Timecode advances
            break;
        case 'ARRIVE':
            vhsUniforms.uFFSpeed.value = easeOut(1 - localProgress) * 1.0;
            vhsUniforms.uTrackingError.value = 0.1 * (1 - localProgress);
            break;
    }

    navigationStore.setState({ transitionProgress: newProgress });
};
```

---

## CRT Screen Content Layout

### Screen Coordinate System

The offscreen scene uses an orthographic camera. Screen space is normalized:

```
(-1, 1) ─────────────────── (1, 1)
│                                │
│  TITLE AREA (top 10%)          │
│  ─────────────────────         │
│                                │
│  CONTENT AREA (middle 75%)     │
│  - Documentation text          │
│  - Links (shootable)           │
│  - Code blocks                 │
│                                │
│  ─────────────────────         │
│  VCR OSD (bottom 15%)          │
│  [▶ PLAY] [00:12:34:15]       │
│                                │
(-1, -1) ────────────────── (1, -1)
```

### Text Layout Rules

- **Title:** VT323, 1.5x body size, phosphor green, top-center
- **Body text:** VT323, base size, phosphor green, left-aligned with margin
- **Code blocks:** VT323, slightly smaller, amber `#FFAA00`, indented, with dim border
- **Links:** VT323, body size, cyan `#00FFFF`, underlined, with subtle pulse animation. These are `ShootableTarget` components.
- **Headings:** VT323, 1.2x body size, brighter green, with underline
- **List items:** VT323, body size, phosphor green, prefixed with `▸` or `►`
- **Max visible lines:** ~20 (scrollable within a page via VCR PLAY — text scrolls up like a teleprompter)

### Scrolling Within a Page

If a page has more than ~20 lines, the content scrolls:
- **Auto-scroll (PLAY mode):** Text slowly scrolls up like a teleprompter (tape is "playing")
- **Pause:** Stops scrolling. User can read at their pace.
- **Manual scroll:** Shooting a "▼ MORE" target at the bottom scrolls down. Shooting "▲ TOP" scrolls up.
- **Links remain shootable** as they scroll into/out of view

---

## VCR Menu System

### Main Menu (on tape start)

When the tape first loads, before documentation, a VCR-styled menu appears:

```
╔══════════════════════════════════════╗
║  THE BACKLOGS                       ║
║  Documentation System v2.0          ║
║  ──────────────────────────────     ║
║                                     ║
║  ► GETTING STARTED                  ║
║  ► OPERATIONS                       ║
║  ► WORKFLOWS                        ║
║  ► AGENT USAGE                      ║
║  ► SCHEMA & DATA                    ║
║  ► PARITY                           ║
║  ► FAQ                              ║
║                                     ║
║  Shoot a section to begin           ║
║                                     ║
╚══════════════════════════════════════╝
        ▶ PLAY  00:00:00:00
```

Each section is a shootable link that FF's to the appropriate tape position.

### Section Index Pages

Each section also has an index page listing its sub-pages as shootable links.

### Navigation Targets on Every Page

Every documentation page has:
1. **Section links** in the title area (breadcrumb-style)
2. **Internal links** within the content (standard markdown links)
3. **"MENU" link** at the bottom (returns to main menu / tape start = rewind)
4. **"◄ PREV" and "NEXT ►" links** for sequential navigation

---

## Shootable Target Component

```typescript
interface ShootableTargetProps {
    label: string;
    targetPageId: string;
    position: [number, number, number];
    width: number;
    height: number;
    color?: string;        // Default: cyan
    hoverColor?: string;   // Default: white
}

function ShootableTarget({
    label, targetPageId, position, width, height,
    color = '#00FFFF', hoverColor = '#FFFFFF',
}: ShootableTargetProps) {
    const meshRef = useRef<THREE.Mesh>(null);
    const [isTargeted, setIsTargeted] = useState(false);

    // Register with aiming system for raycaster detection
    useEffect(() => {
        aimingSystem.registerTarget(meshRef.current, {
            onTarget: () => setIsTargeted(true),
            onUntarget: () => setIsTargeted(false),
            onShoot: () => {
                navigationStore.getState().navigateTo(targetPageId);
                // Play hit sound + visual feedback
            },
        });
        return () => aimingSystem.unregisterTarget(meshRef.current);
    }, []);

    return (
        <group position={position}>
            {/* Hit area (invisible but raycasted) */}
            <mesh ref={meshRef}>
                <planeGeometry args={[width, height]} />
                <meshBasicMaterial transparent opacity={0} />
            </mesh>

            {/* Visual label */}
            <Text
                font="/fonts/VT323-Regular.ttf"
                color={isTargeted ? hoverColor : color}
                fontSize={0.04}
                anchorX="left"
            >
                {isTargeted ? `► ${label}` : `  ${label}`}
            </Text>

            {/* Targeting highlight */}
            {isTargeted && (
                <mesh>
                    <planeGeometry args={[width + 0.01, height + 0.005]} />
                    <meshBasicMaterial
                        color={hoverColor}
                        transparent
                        opacity={0.1}
                    />
                </mesh>
            )}
        </group>
    );
}
```

---

## Content Store (Zustand)

```typescript
interface ContentState {
    // Manifest (loaded at startup)
    manifest: TapeManifestEntry[];
    tapeModel: TapeModel;

    // Page cache
    loadedPages: Map<string, ParsedPage>;
    currentPage: ParsedPage | null;

    // Loading
    isLoading: boolean;
    loadError: string | null;

    // Actions
    loadManifest: () => Promise<void>;
    loadPage: (pageId: string) => Promise<ParsedPage>;
    getPageByTapePosition: (position: number) => TapeManifestEntry | null;
}
```

---

## Accessibility: Alternative Navigation

When horror is disabled, an alternative traditional navigation mode is available:

- **Tab key:** Cycles through shootable targets (links)
- **Enter/Space:** "Shoots" the focused target (navigates)
- **Arrow keys:** Scroll within a page
- **Escape:** Return to menu
- **ARIA labels:** All shootable targets have descriptive labels
- **Screen reader mode:** A hidden DOM layer provides screen-reader-accessible content (the 3D scene is supplemented with an off-screen readable version)

This ensures the documentation is accessible even without the lightgun mechanic.
