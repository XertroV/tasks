---
id: P52.M3.E1.T001
title: Add unit/integration tests for MCP stdio flows
status: done
estimate_hours: 1.5
complexity: medium
priority: high
depends_on:
- P52.M2.E1.T001
- P52.M2.E1.T002
- P52.M2.E2.T001
tags:
- testing
- mcp
claimed_by: cli-user
claimed_at: '2026-02-21T04:58:07.721771+00:00'
started_at: '2026-02-21T04:58:07.721771+00:00'
completed_at: '2026-02-21T05:00:37.883223+00:00'
duration_minutes: 2.5026906666666666
---

# Add unit/integration tests for MCP stdio flows

## Implementation Notes

- Added integration-style stdio flow coverage in `test/pag_server/mcp/stdio_flow_integration_test.exs`.
  - Covers full loop with representative JSON-RPC sequence:
    - `initialize`
    - `tools/list`
    - `tools/call` success (`session_state`)
  - Covers deterministic `tools/call` invalid-params path.
- Extended parser/handler failure-path coverage for deterministic MCP responses:
  - `test/pag_server/tools/mcp/messages_test.exs`
    - invalid `tools/list` params
    - invalid `tools/call.arguments` type
  - `test/pag_server/tools/mcp/protocol_handler_test.exs`
    - malformed `tools/list` params returns `-32602`
  - `test/pag_server/mcp/stdio_server_test.exs`
    - malformed `tools/list` params preserve request id and return `-32602`
- Added/expanded bridge/target tests as part of end-to-end MCP flow validation:
  - `test/pag_server/mcp/api_bridge_test.exs`
  - `test/pag_server/mcp/target_resolver_test.exs`
  - `test/pag_server/mcp/stdio_runtime_config_test.exs`

## Verification Notes

- Focused MCP suite (appended to `recent-mix-tests.log`) passes:
  - `mix test test/pag_server/mcp/stdio_flow_integration_test.exs test/pag_server/mcp/api_bridge_test.exs test/pag_server/mcp/target_resolver_test.exs test/pag_server/mcp/stdio_runtime_config_test.exs test/pag_server/mcp/stdio_server_test.exs test/pag_server/tools/mcp/messages_test.exs test/pag_server/tools/mcp/protocol_handler_test.exs`
  - Result: 128 tests, 0 failures.
- Ran `mix test.changed` and `mix test.tools` per task requirement.
  - `mix test.changed` fails due unrelated pre-existing failures in previously dirty changed paths outside this MCP scope.
  - `mix test.tools` shows pre-existing approval-manager DB ownership instability in unrelated tool tests; MCP-focused tests in this alias remain green.



## Requirements

- Add focused unit tests for protocol parser/formatter and dispatch behavior.
- Add integration-style tests for full stdio message loop using representative client payloads.
- Keep tests fast and deterministic, avoiding long sleeps or external network dependencies.

## Acceptance Criteria

- Tests cover initialize, tools/list, tools/call success, and key failure paths.
- New test runs are appended to `recent-mix-tests.log` during implementation.
- `mix test.changed` and relevant subsystem aliases pass for this scope, or any pre-existing unrelated failures are explicitly documented.
