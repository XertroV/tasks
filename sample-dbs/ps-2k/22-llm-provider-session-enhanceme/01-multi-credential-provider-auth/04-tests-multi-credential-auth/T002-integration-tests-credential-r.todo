---
id: P22.M1.E4.T002
title: 'Integration tests: credential rotation on 429/401/403/timeout responses'
status: done
estimate_hours: 2.0
complexity: medium
priority: medium
depends_on:
- P22.M1.E2.T002
tags: []
claimed_by: cli-user
claimed_at: '2026-02-18T17:37:45.609724+00:00'
started_at: '2026-02-18T17:37:45.609724+00:00'
completed_at: '2026-02-18T17:45:24.014186+00:00'
duration_minutes: 7.640074183333334
---
Write integration tests for route_with_failover/7 credential rotation. Use Bypass or Mox to simulate provider responses. Test scenarios: - First credential returns 429, second credential succeeds -> success with status updated to :rate_limited - First credential returns 401, second succeeds -> success with status updated to :failed - All credentials exhausted -> {:error, :all_credentials_exhausted} - Single credential provider behaves identically to existing behavior - Cooldown timestamps set correctly per error type Acceptance criteria: - Tests use unique agent/provider names per test - No Process.sleep calls; use deterministic mocking - Tests complete in <5s total