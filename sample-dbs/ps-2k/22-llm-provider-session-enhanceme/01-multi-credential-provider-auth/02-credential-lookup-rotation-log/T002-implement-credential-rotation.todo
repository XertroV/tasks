---
id: P22.M1.E2.T002
title: Implement credential rotation in route_with_failover/7 (try next key on 429/401/403/timeout)
status: done
estimate_hours: 3.0
complexity: high
priority: medium
depends_on:
- P22.M1.E2.T001
tags: []
claimed_by: cli-user
claimed_at: '2026-02-18T15:07:30.110644+00:00'
started_at: '2026-02-18T15:07:30.110644+00:00'
completed_at: '2026-02-18T15:20:16.198537+00:00'
duration_minutes: 12.768131316666667
---
Update lib/pag_server/llm/registry.ex route_with_failover/7 to iterate through credentials from CredentialSelector. On error response: - 429 (rate_limited): mark credential status=:rate_limited, cooldown_until=now+5min, try next - 401/403 (auth_fail): mark credential status=:failed, cooldown_until=now+24h, try next - timeout: mark credential cooldown_until=now+30s (keep active), try next - All credentials exhausted: return {:error, :all_credentials_exhausted} Acceptance criteria: - Rotation happens within the same request (no client retry needed) - Credential status/cooldown updated atomically in DB - Falls back to direct execution if only 1 credential exists (no overhead) - Existing behaviour preserved when only 1 credential