---
id: P3.M3.E2.T004
title: POST /agents endpoint to create agent
status: done
estimate_hours: 1.0
complexity: medium
priority: high
depends_on: []
tags:
- rest
- crud
- agents
claimed_by: cli-user
claimed_at: '2026-02-08T04:17:09.618780+00:00'
started_at: '2026-02-08T04:17:09.618780+00:00'
completed_at: '2026-02-08T04:25:02.431414+00:00'
duration_minutes: 7.8802104
---

# POST /agents endpoint to create agent



## Requirements

- [ ] Create `POST /agents` endpoint in `lib/pag_server_web/controllers/agent_controller.ex`
- [ ] Implement `create/2` action following Phoenix controller patterns
- [ ] Accept JSON request body with agent configuration
- [ ] Validate required fields (name, model)
- [ ] Start agent GenServer via `PagServer.Agents.Supervisor.start_agent/1`
- [ ] Return 201 Created with agent details on success
- [ ] Return 422 Unprocessable Entity on validation errors
- [ ] Add route to `lib/pag_server_web/router.ex`

## Acceptance Criteria

- [ ] Accepts JSON body with `name` (required), `model` (required), and optional `capabilities`, `system_prompt`, `metadata` fields
- [ ] Validates `name` is non-empty string (1-100 chars)
- [ ] Validates `model` follows format "provider/model-name" (e.g., "anthropic/claude-3-5-sonnet-20241022")
- [ ] Generates UUID for agent_id if not provided
- [ ] Starts agent GenServer process successfully
- [ ] Returns 201 with JSON response containing: `{id, name, model, status, created_at, capabilities, system_prompt, metadata}`
- [ ] Returns 422 with error details for invalid input (missing name, invalid model format, etc.)
- [ ] Returns 500 if agent process fails to start
- [ ] Test coverage: valid creation, missing fields, invalid model, duplicate names, process startup failure
- [ ] Handles concurrent creation requests safely

## Context

**Plan References**:
- `.plan/2026-02-05-velvet-cascade/architecture.md` lines 89-96 (REST controllers)

**Key Points**:
- Follow RESTful conventions
- Use Phoenix changesets for validation
- Agent process must start before returning success
- Return proper HTTP status codes

## Notes

Implementation pattern:
```elixir
defmodule PagServerWeb.AgentController do
  use PagServerWeb, :controller
  alias PagServer.Agents.Supervisor, as: AgentSupervisor
  alias PagServer.Schema.Agent

  def create(conn, params) do
    with {:ok, attrs} <- validate_params(params),
         {:ok, agent} <- create_agent_record(attrs),
         {:ok, _pid} <- AgentSupervisor.start_agent(agent.id) do
      conn
      |> put_status(:created)
      |> put_resp_header("location", ~p"/api/agents/#{agent.id}")
      |> json(%{
        id: agent.id,
        name: agent.name,
        model: agent.model,
        status: "idle",
        created_at: agent.inserted_at,
        capabilities: agent.capabilities,
        system_prompt: agent.system_prompt,
        metadata: agent.metadata
      })
    else
      {:error, %Ecto.Changeset{} = changeset} ->
        conn
        |> put_status(:unprocessable_entity)
        |> json(%{errors: translate_errors(changeset)})
      
      {:error, reason} ->
        conn
        |> put_status(:internal_server_error)
        |> json(%{error: "Failed to start agent: #{inspect(reason)}"})
    end
  end
  
  defp validate_params(params) do
    # Use Ecto changeset or parameter validation
  end
end
```

Request example:
```json
POST /api/agents
{
  "name": "code-reviewer",
  "model": "anthropic/claude-3-5-sonnet-20241022",
  "capabilities": ["code_review", "testing"],
  "system_prompt": "You are a code reviewer...",
  "metadata": {"team": "backend"}
}
```

Response example (201 Created):
```json
{
  "id": "550e8400-e29b-41d4-a716-446655440000",
  "name": "code-reviewer",
  "model": "anthropic/claude-3-5-sonnet-20241022",
  "status": "idle",
  "created_at": "2026-02-06T10:30:00Z",
  "capabilities": ["code_review", "testing"],
  "system_prompt": "You are a code reviewer...",
  "metadata": {"team": "backend"}
}
```

Edge cases:
- Model provider not registered - return 422 with clear error
- Agent name conflicts - allow or enforce uniqueness?
- Very long system prompts - validate max length
- Invalid JSON in request - Phoenix handles automatically
