---
id: P51.M2.E3.T003
title: Credentials vault (/api/vault/secrets)
status: blocked
estimate_hours: 1.0
complexity: medium
priority: medium
depends_on: []
tags: []
claimed_by: cli-user
claimed_at: '2026-02-20T18:06:25.122957+00:00'
started_at: '2026-02-20T18:06:25.122957+00:00'
completed_at: null
reason: 'Credentials Vault API is blocked by server-side failures: B168 (authenticated
  list returns 500 missing_workspace_id) and B169 (create crashes with undefined_table
  plugin_credentials_vault_secrets).'
---
## Campaign: Credentials vault plugin

The credentials vault (plugins/credentials_vault/) provides a 1Password-style secret store for agents and humans. Test the full lifecycle.

## Acceptance Criteria
- [ ] Secret CRUD lifecycle works
- [ ] Reveal action requires explicit step (not returned in list/get)
- [ ] Sharing/grants work
- [ ] Version history accessible
- [ ] Rate limiting on reveal (anti-exfil) tested
- [ ] Agent MCP tool access tested (if agent can call vault tool)

## Test Sequence (simple → complex)

### Level 2: Basic Read
1. GET /api/vault/secrets — verify list returns (may be empty)
2. Verify secrets do NOT include plaintext values in list response

### Level 3: CRUD
3. POST /api/vault/secrets — create a secret:
   { name: 'test-api-key', value: 'sk-test-123', scope: 'workspace' }
4. GET /api/vault/secrets/:id — verify metadata returns, value does NOT
5. POST /api/vault/secrets/:id/reveal — verify plaintext value returned
6. PATCH /api/vault/secrets/:id — update the secret value
7. GET /api/vault/secrets/:id/versions — verify version history has 2 entries
8. DELETE /api/vault/secrets/:id — verify removal

### Level 4: Access Control
9. Create a secret scoped to a specific agent
10. POST /api/vault/secrets/:id/share — share with another agent/user
11. GET /api/vault/secrets/:id — as the shared-with user, verify access
12. DELETE /api/vault/secrets/:id/grants/:grant_id — revoke, verify no longer accessible

### Level 5: Rate Limiting
13. Call reveal 5+ times in quick succession — verify rate limit kicks in
14. Verify error message is clear about cooldown

## Notes
AES-256-GCM encryption at rest. The vault plugin may need to be enabled for the workspace first (check /dashboard/plugin-settings).

## Execution Notes (2026-02-21)
- `GET /api/vault/secrets` without auth correctly returns `401` missing credentials.
- `GET /api/vault/secrets` with API key returns `500` (`{"error":"internal error"}`) and server logs `CredentialsVault: list failed: :missing_workspace_id`.
- `POST /api/vault/secrets` with API key and user-scoped payload crashes with `Postgrex.Error` (`undefined_table` for `plugin_credentials_vault_secrets`).
- Filed blocker bugs `B168` (list endpoint workspace context failure) and `B169` (create endpoint missing table crash).
