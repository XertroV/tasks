---
id: B157
title: "spawn_agent_impl.ex executor error branch missing \u2014 CaseClauseError on\
  \ Coordinator failure"
status: done
estimate_hours: 1.0
complexity: low
priority: medium
depends_on: []
tags:
- directive
- coordinator
- error-handling
claimed_by: cli-user
claimed_at: '2026-02-19T04:21:05.860197+00:00'
started_at: '2026-02-19T04:21:05.860197+00:00'
completed_at: '2026-02-19T04:43:17.865044+00:00'
duration_minutes: 22.20008055
---
spawn_agent_impl.ex execute/2 (lines 56â€“72) only pattern-matches {:ok, child_id, child_pid} from Coordinator.spawn_child/2. If the coordinator returns {:error, reason} (e.g. {:error, :max_children}, DB error, registry conflict), the case expression raises a CaseClauseError crash rather than returning a graceful error.

The comment in the code notes this branch was 'currently unreachable' but with a real Coordinator using Registry and Repo, it is fully reachable.

Fix:
Add error clause to the case in execute/2:
  {:error, reason} ->
    Logger.error('Failed to spawn child agent', reason: inspect(reason))
    {:error, 'Failed to spawn agent: #{inspect(reason)}'}

Add test: mock Coordinator.spawn_child to return {:error, :max_children}, verify the tool returns {:error, ...} not a crash.