---
id: B168
title: Credentials Vault API list endpoint returns 500 for authenticated requests
  (missing workspace context)
status: done
estimate_hours: 1.0
complexity: medium
priority: high
depends_on: []
tags:
- credentials-vault
- api
- workspace
claimed_by: cli-user
claimed_at: '2026-02-20T18:28:09.923280+00:00'
started_at: '2026-02-20T18:28:09.923280+00:00'
completed_at: '2026-02-20T18:33:25.324535+00:00'
duration_minutes: 5.256687400000001
---
## Repro
1. Create a personal API key
2. GET /api/vault/secrets with Authorization: Bearer <key>

## Expected
Either a successful metadata list response (possibly empty) or a clear 4xx validation error requiring workspace context.

## Actual
Endpoint returns 500 internal error.

## Evidence
- Response: {"error":"internal error"}
- Server log: CredentialsVault: list failed: :missing_workspace_id

## Playwright Scenario Notes
- Test name: `credentials vault list handles missing workspace context`
- Preconditions: authenticated request context with personal API key.
- Steps:
  1. Send `GET /api/vault/secrets` without workspace context headers/params.
  2. Capture status and payload.
- Assertions:
  - Returns handled `422` validation error (or equivalent explicit 4xx), not 500.
  - Error message indicates missing workspace context.

## Verification
- Ran: `mix test test/pag_server_web/controllers/credentials_vault_controller_test.exs`.
- Confirmed missing workspace context path returns handled 4xx validation response (422) and no internal crash.

## Delegation Instructions

**Delegated to subagent by**: cli-user (primary agent)
**Delegation date**: 2026-02-20 18:28 UTC
**Primary task**: B166 - OpenAI compatibility endpoint returns non-OpenAI error envelope

**Instructions**:
This task was claimed as part of a multi-task batch. The primary agent (cli-user)
should spawn a subagent to complete this task in parallel.

**Recommended approach**:
1. Use the Task tool with subagent_type to create a dedicated agent
2. Provide context from this task file as the prompt
3. Grant necessary tools for task completion
4. Monitor subagent progress
5. Aggregate results upon completion

**Independence verification**:
- Different epic: ✓ (None vs None)
- No dependency chain: ✓ (verified at claim time)
