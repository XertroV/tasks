---
id: B167
title: OpenAI compatibility endpoint does not reject invalid model before provider
  call
status: done
estimate_hours: 0.5
complexity: low
priority: high
depends_on: []
tags:
- openai-compat
- validation
claimed_by: cli-user
claimed_at: '2026-02-20T18:28:09.922215+00:00'
started_at: '2026-02-20T18:28:09.922215+00:00'
completed_at: '2026-02-20T18:33:23.193173+00:00'
duration_minutes: 5.221182483333333
---
## Repro
1. Create a valid PAG API key
2. POST `/v1/chat/completions` with model `not-a-real-model` and simple user message
3. Observe response

## Expected
Invalid model should return 400/404-style OpenAI-compatible validation error without provider call side effects.

## Actual
Endpoint attempts provider request and returns 502 provider credential failure (`no_credentials`) instead of model validation failure.

## Evidence
Response: `{"error":"http_error","message":"Provider request failed: %{reason: :no_credentials, provider: :anthropic, model: \"not-a-real-model\", ...}"}`

## Playwright Scenario Notes
- Test name: `openai compatibility rejects invalid model before provider call`
- Preconditions: valid PAG API key.
- Steps:
  1. Send `POST /v1/chat/completions` with model `not-a-real-model`.
  2. Capture HTTP status and JSON payload.
- Assertions:
  - Request fails fast with validation-style status (4xx), not provider-upstream 502.
  - Error payload indicates invalid/unknown model rather than provider credential failure.

## Verification
- Ran: `mix test test/pag_server_web/controllers/openai_chat_completions_controller_test.exs`.
- Confirmed invalid-model requests return fail-fast validation response instead of invoking provider call path.


## Delegation Instructions

**Delegated to subagent by**: cli-user (primary agent)
**Delegation date**: 2026-02-20 18:28 UTC
**Primary task**: B166 - OpenAI compatibility endpoint returns non-OpenAI error envelope

**Instructions**:
This task was claimed as part of a multi-task batch. The primary agent (cli-user)
should spawn a subagent to complete this task in parallel.

**Recommended approach**:
1. Use the Task tool with subagent_type to create a dedicated agent
2. Provide context from this task file as the prompt
3. Grant necessary tools for task completion
4. Monitor subagent progress
5. Aggregate results upon completion

**Independence verification**:
- Different epic: ✓ (None vs None)
- No dependency chain: ✓ (verified at claim time)
