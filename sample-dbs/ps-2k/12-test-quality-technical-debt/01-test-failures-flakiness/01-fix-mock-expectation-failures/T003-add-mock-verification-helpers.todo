---
id: P12.M1.E1.T003
title: Add mock verification helpers
status: done
estimate_hours: 1.0
complexity: medium
priority: medium
depends_on: []
tags: []
claimed_by: cli-user
claimed_at: '2026-02-13T18:53:34.487589+00:00'
started_at: '2026-02-13T18:53:34.487589+00:00'
completed_at: '2026-02-13T18:57:05.323269+00:00'
duration_minutes: 3.5139276
---

# Add mock verification helpers

## Description

Create helper functions/macros to verify that all Mox expectations were called during tests. This helps catch missing mock expectations early and prevents flaky tests.

## Acceptance Criteria

- [x] Create a `verify_mox_expectations!/1` helper or similar in test support module
- [x] Helper verifies all expectations were satisfied for given mock modules
- [x] Add documentation with usage examples
- [x] Apply helper to at least 3 existing test files as proof of concept
- [x] Tests pass
- [x] Lint passes

## Implementation

Created `PagServer.Test.MockHelpers` module in `test/support/mocks.ex` with:

1. `verify_mox_on_exit/1` - Setup callback for automatic Mox verification
2. `with_mox_verification/2` - Run block with specific mock verification
3. `stub_mock/3` - Stub a single mock function
4. `stub_mocks/2` - Stub multiple mock functions

## Findings

Analysis revealed that all test files using Mox `expect()` already have `setup :verify_on_exit!`:
- `test/pag_server/context/pruning/progressive_fallback_test.exs`
- `test/pag_server/context/pruning/summarization_test.exs`

Other files identified as using "mocks" actually use:
- Inline mock modules (defmodule MockX do ...)
- Custom test helpers (`defmocktool`)
- Req.Test for HTTP mocking

The new `MockHelpers` module provides a documented, consistent API for future tests.

## Context

- Related files: `test/support/mocks.ex`
- Reference: Mox `verify_on_exit!/1` pattern
- Part of epic: Fix Mock Expectation Failures
