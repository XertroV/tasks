---
id: P45.M4.E1.T001
title: Implement per-agent token bucket in ETS
status: done
estimate_hours: 1.5
complexity: medium
priority: high
depends_on:
- P45.M1.E1.T001
tags: []
claimed_by: cli-user
claimed_at: '2026-02-19T19:17:35.194125+00:00'
started_at: '2026-02-19T19:17:35.194125+00:00'
completed_at: '2026-02-19T19:51:03.205108+00:00'
duration_minutes: 33.46684951666666
---
Create CredentialsVault.RateLimiter GenServer. On start, initialize an ETS table :credentials_vault_buckets. API: check_and_take(agent_id) -> :ok | {:error, :rate_limited}. Bucket config: capacity=3, refill_rate=1 token per 30 seconds. Reuse the existing PagServer.RateLimiter.TokenBucket struct for the pure math; the GenServer owns state. Return :rate_limited with a retry_after_ms field so the caller knows when to retry.