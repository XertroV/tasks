---
id: P15.M9.E1.T002
title: Fix :DOWN crash handler to generate per-call error results with correct IDs
status: done
estimate_hours: 2.0
complexity: medium
priority: high
depends_on:
- P15.M9.E1.T001
tags:
- agent-server
- crash-handler
- resilience
claimed_by: cli-user
claimed_at: '2026-02-17T13:30:16.883438+00:00'
started_at: '2026-02-17T13:30:16.883438+00:00'
completed_at: '2026-02-17T13:45:39.213427+00:00'
duration_minutes: 15.372166316666666
---
The current `:DOWN` handler in agent_server.ex (~lines 976-1003) creates a single
failed_execution with `call_id: nil`. This produces a tool_result with
`tool_call_id: nil` which MessageFormatter drops, leaving the assistant's
tool_calls unmatched and poisoning the session.

Fix: Use `state.metadata.pending_tool_calls` (from T001) to generate one error
result per original tool call ID. Fall back to a generic crash result only if
pending_tool_calls is empty (shouldn't happen but defense in depth).

Source: .plan/tool-call-resilience.md â€” Gap 2

Files to modify:
- lib/pag_server/agents/agent_server.ex (handle_info :DOWN clause)

## Acceptance Criteria
- [ ] `:DOWN` handler reads pending_tool_calls from state metadata
- [ ] One error result is generated per pending tool call with correct `call_id`
- [ ] Results are persisted via `append_tool_results` (or equivalent)
- [ ] `pending_tool_calls` is cleared and `tool_execution_in_progress` set to false
- [ ] Agent continues operating (can receive new messages) after crash recovery
- [ ] Test: simulate tool execution crash, verify error results have correct call_ids
