---
id: P2.M6.E2.T004
title: Add token processor tests
status: done
estimate_hours: 0.5
complexity: low
priority: high
depends_on:
- P2.M6.E2.T003
tags:
- testing
- streaming
- unit-tests
- genserver
claimed_by: claude-1
claimed_at: '2026-02-05T17:17:52.841303'
started_at: '2026-02-05T17:17:52.841303'
completed_at: '2026-02-05T17:39:35.402089'
duration_minutes: 21.709346233333335
---

# Add token processor tests

Comprehensive test coverage for token processing, backpressure, and aggregation.

## Requirements

- [ ] Create `test/pag_server/llm/token_processor_test.exs`
- [ ] Test GenServer lifecycle:
  - [ ] Start/stop
  - [ ] Initialization with callbacks
  - [ ] Crash recovery
- [ ] Test token processing:
  - [ ] Single token
  - [ ] Multiple tokens in sequence
  - [ ] Token aggregation correctness
  - [ ] Callback invocation
- [ ] Test backpressure:
  - [ ] Mailbox size monitoring
  - [ ] Backpressure activation threshold
  - [ ] Backpressure deactivation threshold
  - [ ] Signal delivery to HTTP handler
- [ ] Test aggregation:
  - [ ] Message completion detection
  - [ ] Statistics calculation (TTFT, throughput)
  - [ ] Multiple content blocks
  - [ ] Buffer reset after completion
- [ ] Test edge cases:
  - [ ] Very fast token arrival (stress test)
  - [ ] Slow token arrival (timeout handling)
  - [ ] Empty tokens
  - [ ] Malformed events

## Acceptance Criteria

- [ ] All tests pass with `mix test`
- [ ] Test coverage >85% for TokenProcessor module
- [ ] Backpressure tests verify threshold behavior
- [ ] Statistics tests verify accuracy
- [ ] No warnings from ExUnit
- [ ] Tests run in <2 seconds

## Context

**Plan References**:
- `.plan/2026-02-05-velvet-cascade/testing.md` (Testing strategy)

**Key Points**:
- Use `GenServer.call/2` with timeout for synchronous test assertions
- Mock HTTP handler PID for backpressure signal testing
- Use `:sys.get_state/1` for white-box testing if needed
- Test concurrent token processing (parallel casts)

## Notes

**Example Test Structure**:
```elixir
defmodule PAGServer.LLM.TokenProcessorTest do
  use ExUnit.Case, async: true

  alias PAGServer.LLM.TokenProcessor

  describe "token processing" do
    test "accumulates tokens correctly" do
      callback_pid = self()
      callback = fn token -> send(callback_pid, {:token, token}) end
      
      {:ok, processor} = TokenProcessor.start_link(
        agent_id: "test_agent",
        callback: callback
      )
      
      GenServer.cast(processor, {:process_token, "Hello"})
      GenServer.cast(processor, {:process_token, " World"})
      
      assert_receive {:token, "Hello"}
      assert_receive {:token, " World"}
      
      # Verify aggregation
      state = :sys.get_state(processor)
      assert state.buffer == "Hello World"
      assert state.token_count == 2
    end
  end

  describe "backpressure" do
    test "activates when mailbox exceeds threshold" do
      # Flood mailbox with tokens
      {:ok, processor} = TokenProcessor.start_link(
        agent_id: "test_agent",
        callback: fn _ -> :timer.sleep(100) end  # Slow callback
      )
      
      # Send 1500 tokens rapidly
      for i <- 1..1500 do
        GenServer.cast(processor, {:process_token, "token_#{i}"})
      end
      
      # Give time for mailbox check
      :timer.sleep(150)
      
      state = :sys.get_state(processor)
      assert state.backpressure_active == true
    end
  end
end
```

Consider property-based testing with StreamData for token sequence generation.
