---
id: P6.M7.E1.T001
title: Add logger_json dependency and configure for production
status: done
estimate_hours: 2.0
complexity: low
priority: medium
depends_on: []
tags:
- observability
- logging
- json
- audit-gap
claimed_by: cli-user
claimed_at: '2026-02-07T01:23:23.805517+00:00'
started_at: '2026-02-07T01:23:23.805517+00:00'
completed_at: '2026-02-07T01:27:46.364024+00:00'
duration_minutes: 4.375974666666666
---

# Add logger_json dependency and configure for production

Add the `logger_json` hex dependency and configure it so that production environments emit
structured JSON log lines (compatible with ELK, Datadog, CloudWatch, etc.) while development
environments retain human-readable console output.

## Requirements

- [ ] Add `{:logger_json, "~> 6.0"}` to `mix.exs` dependencies
- [ ] Run `mix deps.get` to fetch
- [ ] Configure production logger backend in `config/runtime.exs` or `config/prod.exs`:
  ```elixir
  config :logger, :default_handler,
    formatter: {LoggerJSON.Formatters.Basic, []}
  ```
- [ ] Keep dev/test using default console formatter (no changes to `config/dev.exs`)
- [ ] Configure JSON formatter options:
  - [ ] Include metadata keys: `[:correlation_id, :agent_id, :session_id, :provider, :model, :request_id]`
  - [ ] Set timestamp format to ISO 8601
  - [ ] Include source location (module, function, line) at debug level
- [ ] Add environment variable `LOG_FORMAT` to allow runtime override:
  - [ ] `LOG_FORMAT=json` -> JSON formatter
  - [ ] `LOG_FORMAT=console` -> default console formatter (default for dev)
- [ ] Test JSON output by running app with `MIX_ENV=prod` and verifying log lines parse as valid JSON
- [ ] Verify no existing tests break with the new dependency

## Acceptance Criteria

- [ ] Production logs output valid JSON (one JSON object per line)
- [ ] Dev logs remain human-readable (no JSON wrapping)
- [ ] JSON log entries include `timestamp`, `level`, `message`, and `metadata` fields
- [ ] `LOG_FORMAT` environment variable switches between formatters
- [ ] All existing tests pass
- [ ] JSON logs parseable by `jq` command-line tool

## Context

**Source**: Architecture audit found 181 Logger calls all using unstructured text format.
Production log aggregation tools (ELK, Datadog, Loki) require structured JSON for efficient
indexing, searching, and alerting.

## Notes

**mix.exs Addition**:
```elixir
defp deps do
  [
    # ... existing deps
    {:logger_json, "~> 6.0"}
  ]
end
```

**config/runtime.exs**:
```elixir
if config_env() == :prod do
  log_format = System.get_env("LOG_FORMAT", "json")

  if log_format == "json" do
    config :logger, :default_handler,
      formatter: {LoggerJSON.Formatters.Basic, metadata: :all}
  end
end
```

**Example JSON Output**:
```json
{
  "time": "2026-02-06T10:30:00.000Z",
  "severity": "info",
  "message": "LLM request completed",
  "metadata": {
    "correlation_id": "550e8400-e29b-41d4-a716-446655440000",
    "agent_id": "agent-abc",
    "session_id": "session-xyz",
    "provider": "anthropic",
    "model": "claude-sonnet-4-20250514",
    "duration_ms": 1234
  }
}
```


## Sibling Batch Instructions

**Batch mode**: siblings (same epic: P6.M7.E1)
**Agent**: cli-user
**Date**: 2026-02-07 01:23 UTC
**Sibling tasks**: P6.M7.E1.T002

**Instructions**:
This task is part of a sibling batch from the same epic.
Spawn ONE subagent to implement ALL sibling tasks sequentially.
Work through tasks in order: P6.M7.E1.T001 â†’ P6.M7.E1.T002
Mark each done individually after completion.

**Task files**:
- P6.M7.E1.T001: .tasks/06-observability/07-structured-json-logging/01-logger-json-configuration/T001-add-logger-json-dependency-and.todo
- P6.M7.E1.T002: .tasks/06-observability/07-structured-json-logging/01-logger-json-configuration/T002-ensure-all-logger-calls-includ.todo
