---
id: P6.M1.E4.T001
title: Attach telemetry handlers for all [:pag_server, ...] events in application.ex
status: done
estimate_hours: 2.0
complexity: medium
priority: critical
depends_on: []
tags:
- observability
- telemetry
- audit-gap
claimed_by: cli-user
claimed_at: '2026-02-06T17:13:34.214446'
started_at: '2026-02-06T17:13:34.214446'
completed_at: '2026-02-06T17:23:44.731304'
duration_minutes: 10.175280766666667
---

# Attach telemetry handlers for all [:pag_server, ...] events in application.ex

The codebase emits ~20 telemetry events via `:telemetry.execute/3` across agents, LLM providers,
cache, compression, stats, and tools -- but NO handlers are attached to consume them. This means
all telemetry data is silently discarded. This task creates a central telemetry attachment module
that registers handlers for every event on application startup.

## Requirements

- [ ] Create `lib/pag_server/observability/telemetry_handlers.ex` module
- [ ] Implement `attach_all/0` function using `:telemetry.attach_many/4`
- [ ] Register handlers for ALL of the following event groups:
  - [ ] Agent lifecycle: `[:pag_server, :agent, :lifecycle_hook]`
  - [ ] Agent memory: `[:pag_server, :agent, :memory_bounds]`
  - [ ] Agent shutdown: `[:pag_server, :agent, :shutdown]`
  - [ ] Agent crash recovery: `[:pag_server, :agent, :crash_recovery]`
  - [ ] Agent invalid transition: `[:pag_server, :agent, :invalid_transition]`
  - [ ] Agent context overflow: `[:pag_server, :agent, :context_overflow]`
  - [ ] LLM provider registered: `[:pag_server, :llm, :provider_registered]`
  - [ ] LLM failover: `[:pag_server, :llm, :failover]`
  - [ ] LLM routing: `[:pag_server, :llm, :routing]`
  - [ ] LLM routing error: `[:pag_server, :llm, :routing_error]`
  - [ ] LLM error: `[:pag_server, :llm, :error]`
  - [ ] LLM retry: `[:pag_server, :llm, :retry]`
  - [ ] LLM cache usage: `[:pag_server, :llm, :cache, :usage]`
  - [ ] LLM cache savings: `[:pag_server, :llm, :cache, :savings]`
  - [ ] LLM OpenRouter tool results: `[:pag_server, :llm, :openrouter, :tool_results_submitted]`
  - [ ] Cache events: `[:pag_server, :cache, :hit]`, `[:pag_server, :cache, :miss]`, etc.
  - [ ] Compression: `[:pag_server, :compression, :compressed]`
  - [ ] Stats recorded: `[:pag_server, :stats, :recorded]`
- [ ] Call `TelemetryHandlers.attach_all/0` in `PagServer.Application.start/2`
- [ ] Implement default handler that logs events at `:debug` level with structured metadata
- [ ] Group handlers logically (agent_handlers, llm_handlers, infra_handlers) for maintainability
- [ ] Handle handler crashes gracefully (`:telemetry` detaches on crash -- re-attach strategy)
- [ ] Add tests verifying all handlers are attached after application start

## Acceptance Criteria

- [ ] At least 15 of the ~20 telemetry events have active handlers attached
- [ ] Application boots successfully with all handlers registered
- [ ] Events are logged at `:debug` level (visible with `Logger.configure(level: :debug)`)
- [ ] Handler crash does not crash the application
- [ ] Test confirms `:telemetry.list_handlers/1` returns expected handlers
- [ ] No duplicate handler registrations on restart

## Context

**Source**: Architecture audit identified that 20 telemetry events are emitted but zero handlers
consume them, meaning all instrumentation data is silently lost.

**Relationship to P6.M1.E1.T002**: That task covers only 2 events (LLM request stop, tool execute
stop) specifically for stats tracking. This task provides COMPREHENSIVE coverage of ALL events
and serves as the foundation for metrics, logging, and alerting handlers.

## Notes

**Handler Module Structure**:
```elixir
defmodule PagServer.Observability.TelemetryHandlers do
  require Logger

  @agent_events [
    [:pag_server, :agent, :lifecycle_hook],
    [:pag_server, :agent, :memory_bounds],
    [:pag_server, :agent, :shutdown],
    [:pag_server, :agent, :crash_recovery],
    [:pag_server, :agent, :invalid_transition],
    [:pag_server, :agent, :context_overflow]
  ]

  @llm_events [
    [:pag_server, :llm, :provider_registered],
    [:pag_server, :llm, :failover],
    [:pag_server, :llm, :routing],
    [:pag_server, :llm, :routing_error],
    [:pag_server, :llm, :error],
    [:pag_server, :llm, :retry],
    [:pag_server, :llm, :cache, :usage],
    [:pag_server, :llm, :cache, :savings],
    [:pag_server, :llm, :openrouter, :tool_results_submitted]
  ]

  def attach_all do
    :telemetry.attach_many("pag-agent-handlers", @agent_events, &handle_agent_event/4, nil)
    :telemetry.attach_many("pag-llm-handlers", @llm_events, &handle_llm_event/4, nil)
    # ... more groups
  end

  defp handle_agent_event(event, measurements, metadata, _config) do
    Logger.debug("Telemetry event", event: inspect(event), measurements: measurements, metadata: metadata)
  end
end
```

**Application wiring**:
```elixir
# In PagServer.Application.start/2, before supervision tree:
PagServer.Observability.TelemetryHandlers.attach_all()
```


## Sibling Batch Instructions

**Batch mode**: siblings (same epic: P6.M1.E4)
**Agent**: cli-user
**Date**: 2026-02-07 04:13 UTC
**Sibling tasks**: P6.M1.E4.T002, P6.M1.E4.T003

**Instructions**:
This task is part of a sibling batch from the same epic.
Spawn ONE subagent to implement ALL sibling tasks sequentially.
Work through tasks in order: P6.M1.E4.T001 → P6.M1.E4.T002 → P6.M1.E4.T003
Mark each done individually after completion.

**Task files**:
- P6.M1.E4.T001: .tasks/06-observability/01-stats-tracker/04-telemetry-handler-coverage/T001-attach-telemetry-handlers-for.todo
- P6.M1.E4.T002: .tasks/06-observability/01-stats-tracker/04-telemetry-handler-coverage/T002-create-metrics-handler-module.todo
- P6.M1.E4.T003: .tasks/06-observability/01-stats-tracker/04-telemetry-handler-coverage/T003-wire-handlers-to-log-record-er.todo
