---
id: P47.M4.E2.T001
title: Write integration tests for complete device authorization flow
status: done
estimate_hours: 2.0
complexity: medium
priority: high
depends_on:
- P47.M3.E1.T002
tags: []
claimed_by: cli-user
claimed_at: '2026-02-20T06:43:22.291358+00:00'
started_at: '2026-02-20T06:43:22.291358+00:00'
completed_at: '2026-02-20T06:48:36.708818+00:00'
duration_minutes: 5.24029085
---
Create test/pag_server_web/device_flow_integration_test.exs (or test/pag_server/oauth/). Test the full happy path: POST /oauth/device/code → user approves via /device → poll POST /oauth/device/token → 200 with access_token. Test all error states: authorization_pending (normal polling), slow_down (polling too fast), expired_token (after 900s using mock time), access_denied (user denied), device_code not found. Test brute-force: 5 failed user_code lookups → code expires. Test idempotence: polling after token already issued returns access_denied (used state). Test that issued pag_sk_... key has companion:full scope and can authenticate CompanionSocket. Use async: true with proper test isolation (unique device codes per test).

## Sibling Batch Instructions

**Batch mode**: siblings (same epic: P47.M4.E2)
**Agent**: cli-user
**Date**: 2026-02-20 06:43 UTC
**Sibling tasks**: P47.M4.E2.T002

**Instructions**:
This task is part of a sibling batch from the same epic.
Spawn ONE subagent to implement ALL sibling tasks sequentially.
Work through tasks in order: P47.M4.E2.T001 → P47.M4.E2.T002
Mark each done individually after completion.

**Task files**:
- P47.M4.E2.T001: .tasks/47-device-authorization-grant-rfc/04-rfc-8414-discovery-integration/02-integration-tests-for-device-f/T001-write-integration-tests-for-co.todo
- P47.M4.E2.T002: .tasks/47-device-authorization-grant-rfc/04-rfc-8414-discovery-integration/02-integration-tests-for-device-f/T002-add-mix-test-device-flow-alias.todo
